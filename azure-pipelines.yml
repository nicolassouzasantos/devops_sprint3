trigger:
  branches:
    include:
      - main
      - master

parameters:
- name: createInfra
  displayName: Criar/atualizar infraestrutura (RG, PostgreSQL, Plano, WebApp)?
  type: boolean
  default: true

- name: azureServiceConnection
  displayName: Nome da Service Connection (Azure RM)
  type: string
  default: 'sc-azure-rm'

- name: location
  displayName: Região Azure
  type: string
  default: 'brazilsouth'

- name: prefix
  displayName: Prefixo de nomes (ex.: notesolutions)
  type: string
  default: 'notesolutions'

variables:
- group: vg-segredos-notesolutions   # contém PGPASS como segredo

# variáveis simples
- name: PREFIX
  value: ${{ parameters.prefix }}
- name: PGADMIN
  value: pgadmin
- name: DBNAME
  value: note
- name: JAVA_VERSION
  value: '17'
- name: SKU_PLAN
  value: B1
- name: PG_TIER
  value: Burstable
- name: PG_SKU
  value: Standard_B1ms
- name: PG_VERSION
  value: '16'

stages:
# =======================
# 1) INFRA
# =======================
- stage: Infra
  displayName: 'Infraestrutura (RG, PostgreSQL, Plano, WebApp)'
  condition: and(succeeded(), eq('${{ parameters.createInfra }}', 'true'))
  jobs:
  - job: Provision
    displayName: 'Criar/Atualizar Infra'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: 'Login no Azure e provisionar recursos'
      inputs:
        azureSubscription: '${{ parameters.azureServiceConnection }}'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          # -------- Variáveis --------
          PREFIX='$(PREFIX)'
          LOC='${{ parameters.location }}'
          PGADMIN='$(PGADMIN)'
          PGPASS='$(PGPASS)'
          DBNAME='$(DBNAME)'
          PG_TIER='$(PG_TIER)'
          PG_SKU='$(PG_SKU)'
          PG_VERSION='$(PG_VERSION)'
          SKU_PLAN='$(SKU_PLAN)'
          JAVA_VERSION='$(JAVA_VERSION)'

          # derivados
          RG="${PREFIX}-rg"
          PGSERVER="${PREFIX}-pg"
          PLAN="${PREFIX}-plan"
          APP="${PREFIX}-app"

          echo "### Criando/checando Resource Group"
          az group create -n "$RG" -l "$LOC" 1>/dev/null

          echo "### Criando/checando PostgreSQL Flexible Server"
          if ! az postgres flexible-server show -g "$RG" -n "$PGSERVER" 1>/dev/null 2>&1; then
            az postgres flexible-server create \
              -g "$RG" -n "$PGSERVER" -l "$LOC" \
              --admin-user "$PGADMIN" \
              --admin-password "$PGPASS" \
              --tier "$PG_TIER" \
              --sku-name "$PG_SKU" \
              --version "$PG_VERSION" \
              --yes
          else
            echo "PostgreSQL '$PGSERVER' já existe — pulando criação."
          fi

          echo "### Criando/checando Base de Dados"
          if ! az postgres flexible-server db show -g "$RG" -s "$PGSERVER" -d "$DBNAME" 1>/dev/null 2>&1; then
            az postgres flexible-server db create -g "$RG" -s "$PGSERVER" -d "$DBNAME"
          else
            echo "DB '$DBNAME' já existe — pulando criação."
          fi

          echo "### Regra de firewall (AllowAllAzureIPs)"
          if ! az postgres flexible-server firewall-rule show -g "$RG" -n "$PGSERVER" -r AllowAllAzureIPs 1>/dev/null 2>&1; then
            az postgres flexible-server firewall-rule create -g "$RG" -n "$PGSERVER" \
              -r AllowAllAzureIPs --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0
          else
            echo "Firewall rule 'AllowAllAzureIPs' já existe."
          fi

          echo "### Criando/checando App Service Plan"
          if ! az appservice plan show -g "$RG" -n "$PLAN" 1>/dev/null 2>&1; then
            az appservice plan create -g "$RG" -n "$PLAN" --is-linux --sku "$SKU_PLAN"
          else
            echo "App Service Plan '$PLAN' já existe."
          fi

          echo "### Criando/checando Web App"
          if ! az webapp show -g "$RG" -n "$APP" 1>/dev/null 2>&1; then
            az webapp create -g "$RG" -p "$PLAN" -n "$APP" --runtime "JAVA|${JAVA_VERSION}-java${JAVA_VERSION}"
          else
            echo "Web App '$APP' já existe."
          fi

          echo "### Configurando App Settings (SPRING_DATASOURCE_*, JAVA_OPTS, SCM_DO_BUILD_DURING_DEPLOYMENT)"
          JDBC_URL="jdbc:postgresql://${PGSERVER}.postgres.database.azure.com:5432/${DBNAME}?sslmode=require"

          az webapp config ap
